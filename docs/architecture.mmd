flowchart LR
    CLIENT[Client] -->|HTTP Request| ENVOY[Envoy Proxy]

    subgraph ENVOY_BOX["Envoy"]
        direction TB
        HCM[HTTP Connection Manager]
        WASM[CrowdSec WASM Bouncer<br>proxy-wasm filter]
        ROUTER[Router]
        HCM --> WASM --> ROUTER
    end

    subgraph CROWDSEC["CrowdSec"]
        direction TB
        LAPI[LAPI<br>Decisions API<br>/v1/decisions/stream]
        APPSEC[AppSec<br>WAF Engine<br>port 7422]
    end

    WASM -.->|Periodic sync<br>blocklist decisions| LAPI
    LAPI -.->|new/deleted decisions<br>stored in shared_data| WASM

    WASM ==>|Forward request<br>headers + body<br>for inspection| APPSEC
    APPSEC ==>|200 allow<br>403 block| WASM

    ROUTER -->|Allowed request| BACKEND[Backend Service]
    BACKEND -->|Response| ROUTER

    ENVOY -->|Response| CLIENT

    style CLIENT fill:#90a4ae,color:#fff
    style HCM fill:#1565c0,color:#fff
    style WASM fill:#7b1fa2,color:#fff
    style ROUTER fill:#1565c0,color:#fff
    style LAPI fill:#f57c00,color:#fff
    style APPSEC fill:#f57c00,color:#fff
    style BACKEND fill:#388e3c,color:#fff
    style ENVOY_BOX fill:#e3f2fd,stroke:#1565c0,color:#000
    style CROWDSEC fill:#fff3e0,stroke:#f57c00,color:#000
